<!DOCTYPE html>
<html lang="en" dir="ltr" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDU Parameters Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Roboto:wght@400;500;700;900&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- KIPIC BRAND THEME --- */
        :root {
            --kipic-navy: #002F6C;        
            --kipic-green: #6FAE27;      
            --kipic-gradient: linear-gradient(135deg, var(--kipic-navy) 60%, #004494 100%);
            --operator-blue: #004e92;     

            /* Light Mode */
            --bg-body: #f3f5f8;
            --bg-card: #ffffff;
            --text-main: #2c3e50;
            --text-muted: #6c757d;
            --border-color: #e9ecef;
            --header-text: #ffffff;
            --table-head-bg: #f1f3f5;     
            --table-head-text: #495057;
            --table-stripe: #f8f9fa;
            --table-row-bg: #ffffff;      
            --input-bg: #ffffff;
            --footer-bg: #e9ecef;
            
            /* Badge Colors */
            --badge-bg: var(--kipic-navy);
            --badge-text: #ffffff;
            --badge-border: var(--kipic-navy);
            
            --arrow-color: var(--kipic-navy);
            --placeholder-color: #adb5bd;
            
            --alert-bg: #ffebee;
            --alert-text: #c62828;
            --alert-border: #ef9a9a;
        }

        [data-theme="dark"] {
            /* Dark Mode */
            --bg-body: #121212;
            --bg-card: #1e1e24;
            --text-main: #e0e0e0;
            --text-muted: #b0b0b0;
            --border-color: #343a40;
            --header-text: #e0e0e0;
            
            /* Dark Tables */
            --table-head-bg: #0d1b2a;     
            --table-head-text: #ced4da;
            --table-row-bg: #151a21;      
            --table-stripe: #1c232b;      
            
            --input-bg: #2b2b36;
            --footer-bg: #1a1a1a;
            --kipic-navy: #0d1b2a; 
            --kipic-green: #7bc938;
            
            /* Badge Colors */
            --badge-bg: var(--kipic-green);
            --badge-text: #000000;
            --badge-border: var(--kipic-green);
            
            --arrow-color: var(--kipic-green);
            --placeholder-color: #6c757d;

            --alert-bg: #2c0b0e;
            --alert-text: #ff8a80;
            --alert-border: #5c1e24;
        }

        body {
            font-family: 'Roboto', 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
        }

        /* --- HEADER --- */
        .main-header {
            background: var(--kipic-gradient);
            color: var(--header-text);
            padding: 1.5rem 2rem;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            text-align: center;
            border-bottom: 4px solid var(--kipic-green); 
        }

        .header-title-main {
            font-weight: 800;
            font-size: 1.8rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .header-subtitle {
            font-weight: 400;
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 4px;
            color: #d1e7dd; 
        }

        /* Fixed LTR for Controls */
        .header-controls {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            inset-inline-end: 25px;
            display: flex;
            gap: 12px;
            align-items: center;
            direction: ltr !important; 
        }

        .icon-btn {
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.25);
            color: #fff;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .icon-btn:hover { background: var(--kipic-green); border-color: var(--kipic-green); }

        /* Language Switch */
        .lang-switch-container {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 2px;
            display: flex;
            position: relative;
            cursor: pointer;
            width: 76px;
            height: 34px;
        }
        
        .lang-option {
            flex: 1;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 700;
            z-index: 2;
            line-height: 28px;
            color: rgba(255, 255, 255, 0.6);
            transition: color 0.3s;
        }
        .lang-option.active { color: #fff; }

        .lang-slider {
            position: absolute;
            top: 2px;
            bottom: 2px;
            left: 2px;
            width: 50%;
            background: var(--kipic-green);
            border-radius: 16px;
            transition: transform 0.3s ease;
            z-index: 1;
        }
        
        .lang-switch-container.ar-active .lang-slider {
            transform: translateX(92%);
        }

        /* --- CARDS & COLLAPSE --- */
        .card {
            background-color: var(--bg-card);
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            margin-bottom: 20px;
            overflow: hidden;
            border-top: 3px solid var(--kipic-navy); 
            transition: border-color 0.3s ease;
        }
        
        [data-theme="dark"] .card { border-top-color: var(--kipic-green) !important; }
        
        .card-header-custom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: transparent;
        }

        .card-title-text {
            color: var(--kipic-navy);
            font-weight: 700;
            margin: 0;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        [data-theme="dark"] .card-title-text { color: var(--kipic-green); }

        /* --- FEED BADGE --- */
        .feed-badge {
            background-color: var(--badge-bg);
            border: 1px solid var(--badge-border);
            color: var(--badge-text);
            padding: 5px 16px;
            border-radius: 6px;
            font-family: 'Roboto Mono', monospace;
            font-weight: 700;
            font-size: 0.9rem;
            direction: ltr;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- INPUTS --- */
        .form-label { color: var(--text-muted); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        
        .form-control, .form-select {
            background-color: var(--input-bg);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
            height: 38px;
        }
        
        .form-control::placeholder { 
            color: var(--placeholder-color) !important; 
            opacity: 1 !important; 
        }
        
        .form-control:disabled {
            background-color: rgba(0,0,0,0.05);
            color: var(--text-muted);
            cursor: not-allowed;
            border-color: var(--border-color);
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--kipic-green);
            box-shadow: 0 0 0 3px rgba(111, 174, 39, 0.15);
        }
        
        [dir="rtl"] .form-select { background-position: left 0.75rem center; padding-right: 0.75rem; padding-left: 2.25rem; }

        .btn-calc-custom {
            background-color: var(--operator-blue);
            border-color: var(--operator-blue);
            color: #ffffff;
            transition: all 0.3s ease;
            padding-top: 0; padding-bottom: 0;
            height: 38px;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-calc-custom:hover { background-color: #003d73; border-color: #003d73; color: #ffffff; }
        .btn-calc-custom:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Warning Alert Style */
        .range-warning {
            background-color: var(--alert-bg);
            color: var(--alert-text);
            border: 1px solid var(--alert-border);
            font-size: 0.8rem;
            padding: 8px 12px;
            border-radius: 8px;
            margin-top: 8px;
            display: none; /* Hidden by default */
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        /* --- TABLES --- */
        .table { margin-bottom: 0; border-color: var(--border-color); color: var(--text-main); }
        .table thead th {
            background-color: var(--table-head-bg);
            color: var(--table-head-text);
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: uppercase;
            padding: 10px 15px;
            border-bottom: 2px solid #dee2e6;
        }
        [data-theme="dark"] .table thead th { border-bottom-color: #495057; }
        .table td {
            background-color: var(--table-row-bg);
            padding: 8px 15px;
            vertical-align: middle;
            border-color: var(--border-color);
            color: var(--text-main);
            font-size: 0.9rem;
        }
        .table-hover tbody tr:hover td { background-color: var(--table-stripe); }
        .group-cell {
            background-color: var(--table-head-bg) !important;
            color: var(--kipic-navy);
            font-weight: 700;
            border-inline-end: 2px solid var(--border-color);
        }
        [data-theme="dark"] .group-cell { color: var(--kipic-green); }
        .val-display { font-family: 'Roboto Mono', monospace; font-weight: 600; }
        .unit-small { font-size: 0.8em; color: var(--text-muted); margin-inline-start: 6px; font-weight: 400; }

        /* --- FOOTER & ALERTS --- */
        .quality-alert {
            background-color: rgba(255, 193, 7, 0.1);
            border-inline-start: 4px solid #ffc107;
            padding: 10px 15px;
            font-size: 0.8rem;
            color: var(--text-main);
            border-top: 1px solid var(--border-color);
        }
        .quality-alert ul, .footer-notes ul { list-style: none; padding-left: 0; margin: 0; }
        
        .site-footer {
            margin-top: auto;
            background-color: var(--footer-bg);
            border-top: 1px solid var(--border-color);
            padding: 20px 0;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .footer-notes li { margin-bottom: 8px; padding-inline-start: 15px; position: relative; line-height: 1.5; }
        .footer-notes li::before { content: "•"; color: var(--kipic-green); font-weight: bold; position: absolute; inset-inline-start: 0; }
        
        /* Media Queries */
        @media (min-width: 769px) {
            .collapse-icon { display: none !important; }
            .card-header-custom { cursor: default !important; pointer-events: none; }
            .collapse { display: block !important; height: auto !important; visibility: visible !important; }
            .card-header-custom .header-actions { pointer-events: auto; } 
        }

        @media (max-width: 768px) {
            .main-header { padding: 1rem 1.2rem; }
            .header-title-main { font-size: 1.3rem; }
            .header-subtitle { font-size: 0.9rem; }
            #theme-toggle-btn { display: none !important; }
            .header-controls { position: static; transform: none; margin-top: 10px; justify-content: center; }
            .card { margin-bottom: 12px; }
            .card-body { padding: 0; }
            .table td, .table th { padding: 8px 10px; font-size: 0.8rem; }
            .val-display { font-size: 0.85rem; }
            .card-header-custom { cursor: pointer; padding: 10px 15px; flex-wrap: wrap; gap: 8px; }
            .card-title-text { font-size: 0.95rem; }
            .feed-badge { font-size: 0.75rem; padding: 3px 8px; margin-top: 2px; }
            .header-actions { display: flex; align-items: center; justify-content: space-between; width: 100%; margin-top: 5px; }
            .collapse-icon { transition: transform 0.3s ease; color: var(--arrow-color); font-size: 1rem; font-weight: bold; display: block; }
            [dir="ltr"] .collapse-icon { transform: rotate(-90deg); }
            [dir="rtl"] .collapse-icon { transform: rotate(90deg); }
            .card-header-custom[aria-expanded="true"] .collapse-icon { transform: rotate(0deg) !important; }
        }
    </style>
</head>
<body>

<header class="main-header">
    <div class="container-fluid p-0">
        <div class="row align-items-center justify-content-center position-relative">
            <div class="col-12 text-center">
                <div class="header-title-main" data-i18n="mainTitle">Crude Distillation Unit</div>
                <div class="header-subtitle" data-i18n="subTitle">Operational Parameters</div>
            </div>
            <div class="header-controls">
                <button class="icon-btn" id="theme-toggle-btn" onclick="toggleThemeManual()" title="Switch Theme">
                    <i class="bi bi-sun-fill" id="theme-icon"></i>
                </button>
                
                <div class="lang-switch-container" id="lang-switch" onclick="toggleLanguage()">
                    <div class="lang-slider"></div>
                    <span class="lang-option active" id="opt-en">EN</span>
                    <span class="lang-option" id="opt-ar">AR</span>
                </div>
            </div>
        </div>
    </div>
</header>

<div class="container py-4 py-md-5">
    
    <div class="card p-3 p-md-4">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label" data-i18n="oilType">Oil Type</label>
                <select class="form-select" id="oilTypeSelect" onchange="updateModes()"></select>
            </div>
            <div class="col-md-3">
                <label class="form-label" data-i18n="opMode">Operating Mode</label>
                <select class="form-select" id="modeSelect" onchange="handleModeChange()"></select>
            </div>
            <div class="col-md-2">
                <label class="form-label" data-i18n="inputUnit">Unit</label>
                <select class="form-select" id="unitSelect" onchange="handleModeChange();">
                    <option value="KBPD">KBPD</option>
                    <option value="sm3hr">sm3/h</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label" data-i18n="feedRate">Feed Rate</label>
                <div class="d-flex flex-column">
                    <div class="d-flex gap-2 w-100">
                        <form onsubmit="event.preventDefault(); calculateResults();" class="d-flex gap-2 w-100">
                            <input type="text" class="form-control" id="feedInput" placeholder="Range..." inputmode="decimal" enterkeyhint="go">
                            <button type="button" id="calcBtn" class="btn btn-calc-custom px-4" onclick="calculateResults()" data-i18n="calcBtn">
                                Calculate
                            </button>
                        </form>
                    </div>
                    <div id="rangeAlert" class="range-warning">
                        <i class="bi bi-exclamation-circle-fill"></i>
                        <span id="rangeMsg">Value out of operational range</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 g-md-4" id="results-row" style="display: none;">
        
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header-custom collapsed" data-bs-toggle="collapse" data-bs-target="#collapseParams" aria-expanded="false">
                    <h5 class="card-title-text">
                        <i class="bi bi-speedometer2"></i>
                        <span data-i18n="opParams">Operational Parameters</span>
                    </h5>
                    <div class="header-actions">
                        <div id="feed-display-badge" class="feed-badge">--</div>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                </div>
                <div id="collapseParams" class="collapse">
                    <div class="card-body p-0 table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th data-i18n="paramName">Parameter Name</th>
                                    <th class="text-end" data-i18n="value">Value</th>
                                </tr>
                            </thead>
                            <tbody id="params-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            
            <div class="card mb-3 mb-md-4">
                <div class="card-header-custom collapsed" data-bs-toggle="collapse" data-bs-target="#collapseYields" aria-expanded="false">
                    <div class="header-actions d-flex w-100 justify-content-between align-items-center">
                         <h5 class="card-title-text">
                            <i class="bi bi-graph-up-arrow"></i>
                            <span data-i18n="prodYields">Production Yields</span>
                        </h5>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                </div>
                <div id="collapseYields" class="collapse">
                    <div class="card-body p-0">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th data-i18n="product">Product</th>
                                    <th class="text-end">Flow (sm3/h)</th>
                                </tr>
                            </thead>
                            <tbody id="yields-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="card mb-0">
                <div class="card-header-custom collapsed" data-bs-toggle="collapse" data-bs-target="#collapseQuality" aria-expanded="false">
                    <div class="header-actions d-flex w-100 justify-content-between align-items-center">
                        <h5 class="card-title-text">
                            <i class="bi bi-clipboard-check"></i>
                            <span data-i18n="prodQuality">Quality Specifications</span>
                        </h5>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                </div>
                <div id="collapseQuality" class="collapse">
                    <div class="card-body p-0 table-responsive">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th data-i18n="stream">Stream</th>
                                    <th data-i18n="property">Property</th>
                                    <th class="text-end" data-i18n="limit">Limit/Value</th>
                                </tr>
                            </thead>
                            <tbody id="quality-body"></tbody>
                        </table>
                    </div>
                    
                    <div class="quality-alert" id="quality-notes-area" style="display: none;">
                        <ul id="quality-notes-list"></ul>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<footer class="site-footer">
    <div class="container">
        <h6 class="fw-bold mb-3 text-uppercase" style="color: var(--text-main);">
            <i class="bi bi-info-circle-fill me-2"></i><span data-i18n="notesTitle">General Notes & Guidelines</span>
        </h6>
        <div class="footer-notes">
            <ul id="footer-static-notes">
                <li data-i18n="note1"></li>
                <li data-i18n="note2"></li>
                <li data-i18n="note3"></li>
            </ul>
        </div>
    </div>
</footer>

<script>
    // --- HELPER: Parse English or Arabic Numerals ---
    function parseLocaleNumber(stringNumber) {
        if (!stringNumber) return NaN;
        stringNumber = stringNumber.toString();
        var englishDigits = stringNumber
            .replace(/[٠-٩]/g, d => "٠١٢٣٤٥٦٧٨٩".indexOf(d));
        return parseFloat(englishDigits);
    }

    // --- DATA STRUCTURE (CLEANED UP) ---
    // All Feed SM3 values are rounded to 1 decimal.
    // Washwater units updated to sm3/h.
    // Data values rounded to match visible Excel numbers (Integers for flows/temps).
    const DB = {
        "KEC": {
            "Max Kero (with Heavy Diesel)": {
                feedsKBPD: [205, 200, 175, 155, 130, 105],
                feedsSM3:  [1342.0, 1321.0, 1159.4, 1031.3, 851.6, 696.4],
                params: {
                    "Slops": {u: "sm3/h", v: [36, 33, 30, 41, 3, 0]},
                    "Wild Naphtha": {u: "sm3/h", v: [10, 9, 27, 10, 7, 10]},
                    "Heater Feed Rate": {u: "sm3/h", v: [1230, 1220, 1056, 970, 805, 660]},
                    "Washwater to Desalter V02": {u: "sm3/h", v: [50, 53, 45, 41, 34, 27]},
                    "Washwater to E01": {u: "sm3/h", v: [17, 18, 15, 14, 12, 9]},
                    "V-0001 Inlet Temperature": {u: "°C", v: [149, 149, 150, 148, 149, 147]},
                    "V-0002 Inlet Temperature": {u: "°C", v: [148, 148, 149, 147, 148, 146]},
                    "E-10 Outlet Temperature": {u: "°C", v: [200, 202, 200, 198, 200, 203]},
                    "Heater Outlet Temperature": {u: "°C", v: [371, 371, 371, 371, 370, 371]},
                    "Column Top Temperature": {u: "°C", v: [112, 112, 112, 111, 111, 111]},
                    "Top Column Pressure": {u: "barg", v: [1.03, 1.03, 1.03, 1.02, 1.03, 1.00]},
                    "Top Pump Around Flow": {u: "sm3/h", v: [1621, 1550, 1385, 1360, 1160, 1170]},
                    "Top Pump Around Draw Temperature": {u: "°C", v: [127, 126, 128, 126, 127, 127]},
                    "Top Pump Around Return Temperature": {u: "°C", v: [103, 105, 105, 105, 106, 107]},
                    "Middle Pump Around Flow": {u: "sm3/h", v: [1186, 1124, 1015, 890, 766, 685]},
                    "Middle Pump Around Draw Temperature": {u: "°C", v: [219, 216, 217, 213, 208, 208]},
                    "Middle Pump Around Return Temperature": {u: "°C", v: [165, 158, 164, 158, 154, 160]},
                    "Bottom Pump Around Flow": {u: "sm3/h", v: [900, 1002, 775, 780, 700, 541]},
                    "Bottom Pump Around Draw Temperature": {u: "°C", v: [291, 291, 296, 292, 287, 287]},
                    "Bottom Pump Around Return Temperature": {u: "°C", v: [244, 246, 249, 248, 248, 246]},
                    "Column Bottom Temperature": {u: "°C", v: [348, 349, 345, 347, 344, 342]},
                    "Kerosene Draw Temperature": {u: "°C", v: [178, 176, 179, 176, 177, 179]},
                    "Kerosene Reboiler Temperature": {u: "°C", v: [216, 216, 215, 216, 217, 218]},
                    "Light Diesel Draw Temperature": {u: "°C", v: [264, 262, 266, 261, 259, 259]},
                    "Heavy Diesel Draw Temperature": {u: "°C", v: [318, 320, 317, 316, 310, 310]},
                    "Overflash Flow": {u: "sm3/h", v: [113, 84, 108, 83, 75, 73]},
                    "Stripping Steam Temperature": {u: "°C", v: [275, 285, 290, 290, 284, 274]},
                    "Stripping Steam (Crude)": {u: "kg/hr", v: [22500, 21998, 20500, 17500, 15374, 15500]},
                    "Stripping Steam (Light Diesel)": {u: "kg/hr", v: [1200, 2150, 1092, 1450, 1209, 1000]},
                    "Stripping Steam (Heavy Diesel)": {u: "kg/hr", v: [350, 450, 300, 300, 300, 300]},
                    "Stabilizer Feed Temperature": {u: "°C", v: [102, 104, 102, 106, 108, 110]},
                    "Stabilizer Reboiler Inlet Temperature": {u: "°C", v: [147, 148, 149, 151, 153, 155]},
                    "Stabilizer Reboiler Outlet Temperature": {u: "°C", v: [160, 158, 159, 158, 159, 160]},
                    "Stabilizer Reflux Flow": {u: "sm3/h", v: [35, 30, 32, 26, 21, 21]},
                    "Bottom Pump Around to Reboiler Inlet": {u: "°C", v: [235, 219, 227, 221, 218, 217]},
                    "Bottom Pump Around to Reboiler Flow": {u: "sm3/h", v: [900, 1002, 775, 780, 700, 541]},
                    "AR Product Temperature": {u: "°C", v: [170, 164, 170, 161, 166, 157]}
                },
                yields: {
                    "LPG": [16, 17, 13, 15, 15, 13],
                    "Naphtha": [266, 258, 214, 193, 143, 108],
                    "Kerosene": [241, 241, 205, 183, 128, 112],
                    "Light Diesel": [199, 200, 185, 161, 135, 105],
                    "Heavy Diesel": [55, 67, 20, 30, 20, 25],
                    "Atmospheric Residue (AR)": [618, 601, 541, 500, 444, 359]
                },
                quality: {
                    "Desalted Crude": { "Salt HEM": {u: "PTB", v: [0.8, 0.5, 0.68, 0.55, 0.45, 0.6]}, "BS&W": {u: "%", v: [1.4, 1.0, 0.7, 0.6, 0.5, 0.5]} },
                    "Desalter Effluent": { "pH": {u: "pH", v: [5.0, 7.6, 6.0, 5.8, 7.0, 5.5]} },
                    "SSW": { "pH": {u: "pH", v: [8.5, 9.0, 9.57, 8.7, 9.0, 7.8]} },
                    "Naphtha": { "RVP": {u: "psi", v: [8.8, 9.1, 8.35, 8.9, 8.76, 8.8]}, "T95": {u: "°C", v: [141, 140, 143, 139, 143, 143]} },
                    "Kerosene": { "Freeze Point": {u: "°C", v: [-48, -51, -50, -51, -54, -52]}, "T95": {u: "°C", v: [245, 240, 245, 239, 232, 237]} },
                    "Diesel": { "T95": {u: "°C", v: [348, 356, 339, 340, 320, 324]}, "Cloud Point": {u: "°C", v: [-2, -1, -6, -5.5, -12, -9]} },
                    "AR": { "API": {u: "API", v: [13.0, 13.0, 12.6, 12.9, 12.5, 13.0]}, "Sulfur": {u: "wt%", v: [5.0, 4.59, 4.5, 4.6, 4.5, 4.4]} }
                }
            },
            "Max Kero (No Heavy Diesel)": {
                feedsKBPD: [200, 195, 180, 160, 150, 120, 105],
                feedsSM3: [1326.7, 1300.3, 1203.9, 1060.7, 979.9, 789.7, 689.4],
                params: {
                    "Slops": {u: "sm3/h", v: [49, 26, 3, 34, 25, 0, 0]},
                    "Wild Naphtha": {u: "sm3/h", v: [0, 7, 30, 8, 0, 28, 12]},
                    "Heater Feed Rate": {u: "sm3/h", v: [1220, 1200, 1081, 960, 898, 674, 660]},
                    "Washwater to Desalter V02": {u: "sm3/h", v: [50, 52, 45, 46, 37, 32, 27]},
                    "Washwater to E01": {u: "sm3/h", v: [16, 20, 15, 14, 12, 10, 9]},
                    "V-0001 Inlet Temperature": {u: "°C", v: [147, 151, 150, 151, 150, 150, 148]},
                    "V-0002 Inlet Temperature": {u: "°C", v: [146, 150, 149, 150, 149, 149, 147]},
                    "E-10 Outlet Temperature": {u: "°C", v: [200, 207, 194, 26, 195, 206, 202]},
                    "Heater Outlet Temperature": {u: "°C", v: [371, 369, 371, 371, 371, 368, 371]},
                    "Column Top Temperature": {u: "°C", v: [111, 111, 112, 110, 112, 112, 111]},
                    "Top Column Pressure": {u: "barg", v: [1.03, 1.04, 1.03, 1.03, 1.03, 0.97, 1.00]},
                    "Top Pump Around Flow": {u: "sm3/h", v: [1670, 1345, 1431, 1391, 1191, 1058, 1170]},
                    "Top Pump Around Draw Temperature": {u: "°C", v: [125, 127, 127, 126, 129, 124, 127]},
                    "Top Pump Around Return Temperature": {u: "°C", v: [104, 106, 101, 107, 104, 103, 108]},
                    "Middle Pump Around Flow": {u: "sm3/h", v: [1180, 1245, 1040, 892, 870, 798, 682]},
                    "Middle Pump Around Draw Temperature": {u: "°C", v: [217, 227, 216, 214, 217, 206, 208]},
                    "Middle Pump Around Return Temperature": {u: "°C", v: [157, 157, 167, 167, 166, 163, 158]},
                    "Bottom Pump Around Flow": {u: "sm3/h", v: [965, 1045, 790, 770, 666, 620, 541]},
                    "Bottom Pump Around Draw Temperature": {u: "°C", v: [291, 290, 297, 294, 296, 288, 288]},
                    "Bottom Pump Around Return Temperature": {u: "°C", v: [246, 263, 251, 250, 251, 258, 246]},
                    "Column Bottom Temperature": {u: "°C", v: [344, 341, 344, 343, 345, 339, 336]},
                    "Kerosene Draw Temperature": {u: "°C", v: [176, 176, 175, 175, 179, 173, 179]},
                    "Kerosene Reboiler Temperature": {u: "°C", v: [215, 218, 214, 216, 216, 218, 217]},
                    "Light Diesel Draw Temperature": {u: "°C", v: [265, 269, 264, 262, 266, 260, 261]},
                    "Heavy Diesel Draw Temperature": {u: "°C", v: [24, 43, 53, 49, 33, 44, 22]},
                    "Overflash Flow": {u: "sm3/h", v: [33, 0, 152, 126, 85, 68, 87]},
                    "Stripping Steam Temperature": {u: "°C", v: [275, 268, 288, 280, 281, 265, 273]},
                    "Stripping Steam (Crude)": {u: "kg/hr", v: [23893, 23944, 19997, 20523, 17341, 14314, 15248]},
                    "Stripping Steam (Light Diesel)": {u: "kg/hr", v: [1300, 2300, 1100, 1200, 941, 2035, 1000]},
                    "Stripping Steam (Heavy Diesel)": {u: "kg/hr", v: [27, 105, -13, -13, 83, 128, 35]},
                    "Stabilizer Feed Temperature": {u: "°C", v: [105, 112, 118, 115, 106, 128, 110]},
                    "Stabilizer Reboiler Inlet Temperature": {u: "°C", v: [147, 154, 150, 151, 151, 162, 156]},
                    "Stabilizer Reboiler Outlet Temperature": {u: "°C", v: [159, 215, 160, 159, 158, 166, 160]},
                    "Stabilizer Reflux Flow": {u: "sm3/h", v: [29, 13, 37, 27, 23, 16, 22]},
                    "Bottom Pump Around to Reboiler Inlet": {u: "°C", v: [228, 264, 209, 206, 226, 200, 216]},
                    "Bottom Pump Around to Reboiler Flow": {u: "sm3/h", v: [965, 569, 440, 369, 666, 462, 541]},
                    "AR Product Temperature": {u: "°C", v: [168, 170, 176, 157, 170, 169, 156]}
                },
                yields: {
                    "LPG": [18, 2, 13, 12, 12, 1, 13],
                    "Naphtha": [267, 225, 235, 187, 183, 138, 112],
                    "Kerosene": [243, 228, 204, 167, 169, 104, 111],
                    "Light Diesel": [208, 198, 195, 174, 158, 134, 110],
                    "Heavy Diesel": [0, 0, 0, 0, 0, 0, 0],
                    "Atmospheric Residue (AR)": [652, 680, 578, 541, 479, 390, 377]
                },
                quality: {
                    "Desalted Crude": { "Salt HEM": {u: "PTB", v: [0.65, 0.6, 0.6, 0.7, 1.0, 0.6, 0.6]}, "BS&W": {u: "%", v: [1.3, 0.6, 0.8, 0.7, 0.55, 0.5, 0.5]} },
                    "Desalter Effluent": { "pH": {u: "pH", v: [5.0, 5.0, 5.0, 7.0, 4.9, 5.4, 5.45]} },
                    "SSW": { "pH": {u: "pH", v: [8.5, 8, 8.1, 9, 9.4, 8.5, 7.5]} },
                    "Naphtha": { "RVP": {u: "psi", v: [9.16, 9.1, 8.9, 8.45, 8.51, 8, 8.65]}, "T95": {u: "°C", v: [143, 147, 144, 142, 140, 145, 143]} },
                    "Kerosene": { "Freeze Point": {u: "°C", v: [-48, -49, -48, -52, -51, -56, -52]}, "T95": {u: "°C", v: [245, 252, 247, 240, 245, 231, 238]} },
                    "Diesel": { "T95": {u: "°C", v: [331, 325, 334, 327, 336, 324, 311]}, "Cloud Point": {u: "°C", v: [-6, -9, -6, -9, -6, -11, -13]} },
                    "AR": { "API": {u: "API", v: [12.6, 13.1, 12.9, 13, 12.9, 13, 14]}, "Sulfur": {u: "wt%", v: [4.6, 4.4, 4.66, 4.8, 4.4, 4.3, 4.38]} }
                }
            },
             "Max Naphtha Mode": {
                feedsKBPD: [205],
                feedsSM3: [1367.7],
                params: {
                    "Slops": {u: "sm3/h", v: [11]},
                    "Wild Naphtha": {u: "sm3/h", v: [20]},
                    "Heater Feed Rate": {u: "sm3/h", v: [1200]},
                    "Washwater to Desalter V02": {u: "sm3/h", v: [54]},
                    "Washwater to E01": {u: "sm3/h", v: [18]},
                    "V-0001 Inlet Temperature": {u: "°C", v: [150]},
                    "V-0002 Inlet Temperature": {u: "°C", v: [149]},
                    "E-10 Outlet Temperature": {u: "°C", v: [201]},
                    "Heater Outlet Temperature": {u: "°C", v: [371]},
                    "Column Top Temperature": {u: "°C", v: [115]},
                    "Top Column Pressure": {u: "barg", v: [1.00]},
                    "Top Pump Around Flow": {u: "sm3/h", v: [1621]},
                    "Top Pump Around Draw Temperature": {u: "°C", v: [128]},
                    "Top Pump Around Return Temperature": {u: "°C", v: [106]},
                    "Middle Pump Around Flow": {u: "sm3/h", v: [1261]},
                    "Middle Pump Around Draw Temperature": {u: "°C", v: [219]},
                    "Middle Pump Around Return Temperature": {u: "°C", v: [168]},
                    "Bottom Pump Around Flow": {u: "sm3/h", v: [901]},
                    "Bottom Pump Around Draw Temperature": {u: "°C", v: [296]},
                    "Bottom Pump Around Return Temperature": {u: "°C", v: [257]},
                    "Column Bottom Temperature": {u: "°C", v: [343]},
                    "Kerosene Draw Temperature": {u: "°C", v: [177]},
                    "Kerosene Reboiler Temperature": {u: "°C", v: [215]},
                    "Light Diesel Draw Temperature": {u: "°C", v: [270]},
                    "Heavy Diesel Draw Temperature": {u: "°C", v: [66]},
                    "Overflash Flow": {u: "sm3/h", v: [99]},
                    "Stripping Steam Temperature": {u: "°C", v: [288]},
                    "Stripping Steam (Crude)": {u: "kg/hr", v: [24500]},
                    "Stripping Steam (Light Diesel)": {u: "kg/hr", v: [930]},
                    "Stripping Steam (Heavy Diesel)": {u: "kg/hr", v: [0]},
                    "Stabilizer Feed Temperature": {u: "°C", v: [117]},
                    "Stabilizer Reboiler Inlet Temperature": {u: "°C", v: [150]},
                    "Stabilizer Reboiler Outlet Temperature": {u: "°C", v: [161]},
                    "Stabilizer Reflux Flow": {u: "sm3/h", v: [32]},
                    "Bottom Pump Around to Reboiler Inlet": {u: "°C", v: [220]},
                    "Bottom Pump Around to Reboiler Flow": {u: "sm3/h", v: [400]},
                    "AR Product Temperature": {u: "°C", v: [171]}
                },
                yields: { "LPG": [10], "Naphtha": [249], "Kerosene": [227], "Light Diesel": [222], "Heavy Diesel": [0], "AR": [654] },
                quality: { 
                    "Desalted Crude": { "Salt HEM": {u:"PTB", v:[0.7]}, "BS&W": {u:"%", v:[1.0]} },
                    "Desalter Effluent": { "pH": {u: "pH", v: [6.0]} },
                    "SSW": { "pH": {u: "pH", v: [9.5]} },
                    "Naphtha": { "RVP": {u:"psi", v:[8.5]}, "T95": {u:"°C", v:[147]} },
                    "Kerosene": { "Freeze Point": {u:"°C", v:[-49]}, "T95": {u:"°C", v:[248]} },
                    "Diesel": { "T95": {u:"°C", v:[335]}, "Cloud Point": {u:"°C", v:[-6]} },
                    "AR": { "API": {u: "API", v: [12.8]}, "Sulfur": {u:"wt%", v:[4.44]} }
                }
            },
            "KSRC": {
                "Base Case": {
                    feedsKBPD: [120],
                    feedsSM3: [809.9],
                    params: {
                        "Slops": {u: "sm3/h", v: [8]},
                        "Wild Naphtha": {u: "sm3/h", v: [4]},
                        "Heater Feed Rate": {u: "sm3/h", v: [950]},
                        "Washwater to Desalter V02": {u: "sm3/h", v: [72]},
                        "Washwater to E01": {u: "sm3/h", v: [24]},
                        "V-0001 Inlet Temperature": {u: "°C", v: [150]},
                        "V-0002 Inlet Temperature": {u: "°C", v: [146]},
                        "E-10 Outlet Temperature": {u: "°C", v: [201]},
                        "Heater Outlet Temperature": {u: "°C", v: [370]},
                        "Column Top Temperature": {u: "°C", v: [113]},
                        "Top Column Pressure": {u: "barg", v: [1.00]},
                        "Top Pump Around Flow": {u: "sm3/h", v: [1270]},
                        "Top Pump Around Draw Temperature": {u: "°C", v: [134]},
                        "Top Pump Around Return Temperature": {u: "°C", v: [109]},
                        "Middle Pump Around Flow": {u: "sm3/h", v: [862]},
                        "Middle Pump Around Draw Temperature": {u: "°C", v: [222]},
                        "Middle Pump Around Return Temperature": {u: "°C", v: [166]},
                        "Bottom Pump Around Flow": {u: "sm3/h", v: [532]},
                        "Bottom Pump Around Draw Temperature": {u: "°C", v: [292]},
                        "Bottom Pump Around Return Temperature": {u: "°C", v: [256]},
                        "Column Bottom Temperature": {u: "°C", v: [348]},
                        "Kerosene Draw Temperature": {u: "°C", v: [189]},
                        "Kerosene Reboiler Temperature": {u: "°C", v: [220]},
                        "Light Diesel Draw Temperature": {u: "°C", v: [262]},
                        "Heavy Diesel Draw Temperature": {u: "°C", v: [25]},
                        "Overflash Flow": {u: "sm3/h", v: [62]},
                        "Stripping Steam Temperature": {u: "°C", v: [303]},
                        "Stripping Steam (Crude)": {u: "kg/hr", v: [9650]},
                        "Stripping Steam (Light Diesel)": {u: "kg/hr", v: [2500]},
                        "Stripping Steam (Heavy Diesel)": {u: "kg/hr", v: [109]},
                        "Stabilizer Feed Temperature": {u: "°C", v: [111]},
                        "Stabilizer Reboiler Inlet Temperature": {u: "°C", v: [175]},
                        "Stabilizer Reboiler Outlet Temperature": {u: "°C", v: [187]},
                        "Stabilizer Reflux Flow": {u: "sm3/h", v: [0]},
                        "Bottom Pump Around to Reboiler Inlet": {u: "°C", v: [213]},
                        "Bottom Pump Around to Reboiler Flow": {u: "sm3/h", v: [239]},
                        "AR Product Temperature": {u: "°C", v: [175]}
                    },
                    yields: { "LPG": [0], "Naphtha": [128], "Kerosene": [47], "Light Diesel": [143], "Heavy Diesel": [0], "AR": [533] },
                    quality: { 
                        "Desalted Crude": { "Salt HEM": {u:"PTB", v:[0.4]}, "BS&W": {u:"%", v:[0.7]} },
                        "Naphtha": { "RVP": {u:"psi", v:[7.25]}, "T95": {u:"°C", v:[146]} },
                        "Kerosene": { "Freeze Point": {u:"°C", v:[-81]}, "T95": {u:"°C", v:[221]} },
                        "Diesel": { "T95": {u:"°C", v:[320]}, "Cloud Point": {u:"°C", v:[-36]} },
                        "AR": { "Sulfur": {u:"wt%", v:[5.78]} }
                    }
                }
            },
            "KMHC": {
                "Base Case": {
                    feedsKBPD: [200, 120],
                    feedsSM3: [1312.0, 810.7],
                    params: {
                        "Slops": {u: "sm3/h", v: [25, 0]},
                        "Wild Naphtha": {u: "sm3/h", v: [2, 3]},
                        "Heater Feed Rate": {u: "sm3/h", v: [1200, 735]},
                        "Washwater to Desalter V02": {u: "sm3/h", v: [52, 51]},
                        "Washwater to E01": {u: "sm3/h", v: [20, 17]},
                        "V-0001 Inlet Temperature": {u: "°C", v: [151, 145]},
                        "V-0002 Inlet Temperature": {u: "°C", v: [150, 144]},
                        "E-10 Outlet Temperature": {u: "°C", v: [189, 201]},
                        "Heater Outlet Temperature": {u: "°C", v: [369, 370]},
                        "Column Top Temperature": {u: "°C", v: [112, 112]},
                        "Top Column Pressure": {u: "barg", v: [1.01, 1.00]},
                        "Top Pump Around Flow": {u: "sm3/h", v: [1339, 1270]},
                        "Top Pump Around Draw Temperature": {u: "°C", v: [128, 129]},
                        "Top Pump Around Return Temperature": {u: "°C", v: [107, 109]},
                        "Middle Pump Around Flow": {u: "sm3/h", v: [1243, 623]},
                        "Middle Pump Around Draw Temperature": {u: "°C", v: [227, 216]},
                        "Middle Pump Around Return Temperature": {u: "°C", v: [156, 170]},
                        "Bottom Pump Around Flow": {u: "sm3/h", v: [1038, 548]},
                        "Bottom Pump Around Draw Temperature": {u: "°C", v: [291, 293]},
                        "Bottom Pump Around Return Temperature": {u: "°C", v: [264, 251]},
                        "Column Bottom Temperature": {u: "°C", v: [342, 348]},
                        "Kerosene Draw Temperature": {u: "°C", v: [177, 179]},
                        "Kerosene Reboiler Temperature": {u: "°C", v: [218, 220]},
                        "Light Diesel Draw Temperature": {u: "°C", v: [269, 259]},
                        "Heavy Diesel Draw Temperature": {u: "°C", v: [43, 23]},
                        "Overflash Flow": {u: "sm3/h", v: [0, 97]},
                        "Stripping Steam Temperature": {u: "°C", v: [268, 265]},
                        "Stripping Steam (Crude)": {u: "kg/hr", v: [23972, 15123]},
                        "Stripping Steam (Light Diesel)": {u: "kg/hr", v: [2340, 1776]},
                        "Stripping Steam (Heavy Diesel)": {u: "kg/hr", v: [108, 108]},
                        "Stabilizer Feed Temperature": {u: "°C", v: [112, 116]},
                        "Stabilizer Reboiler Inlet Temperature": {u: "°C", v: [154, 169]},
                        "Stabilizer Reboiler Outlet Temperature": {u: "°C", v: [215, 201]},
                        "Stabilizer Reflux Flow": {u: "sm3/h", v: [17, 2]},
                        "Bottom Pump Around to Reboiler Inlet": {u: "°C", v: [264, 246]},
                        "Bottom Pump Around to Reboiler Flow": {u: "sm3/h", v: [562, 403]},
                        "AR Product Temperature": {u: "°C", v: [169, 161]}
                    },
                    yields: { "LPG": [3, 4], "Naphtha": [223, 130], "Kerosene": [225, 106], "Light Diesel": [198, 128], "Heavy Diesel": [0, 0], "AR": [680, 424] },
                    quality: { 
                        "Desalted Crude": { "Salt HEM": {u:"PTB", v:[0.6, 1.1]}, "BS&W": {u:"%", v:[0.6, 1.0]} },
                        "Desalter Effluent": { "pH": {u: "pH", v: [5.1, 5.0]} },
                        "SSW": { "pH": {u: "pH", v: [7.9, 8.5]} },
                        "Naphtha": { "RVP": {u:"psi", v:[9.0, 8.1]}, "T95": {u:"°C", v:[146, 148]} },
                        "Kerosene": { "Freeze Point": {u:"°C", v:[-49, -48]}, "T95": {u:"°C", v:[250, 245]} },
                        "Diesel": { "T95": {u:"°C", v:[323, 330]}, "Cloud Point": {u:"°C", v:[-9, -7]} },
                        "AR": { "API": {u: "API", v: [12.9, 12.0]}, "Sulfur": {u:"wt%", v:[4.46, 4.92]} }
                    }
                }
            }
        };

    const MODE_LABELS = {
        "Max Kero (with Heavy Diesel)": { en: "with Heavy Diesel", ar: "مع ديزل ثقيل" },
        "Max Kero (No Heavy Diesel)": { en: "no Heavy Diesel", ar: "بدون ديزل ثقيل" },
        "Max Naphtha Mode": { en: "Naphtha Mode", ar: "وضع النافثا" },
        "Base Case": { en: "Base Case", ar: "الحالة الأساسية" }
    };

    const STRINGS = {
        en: {
            mainTitle: "Crude Distillation Unit", subTitle: "Operational Parameters",
            oilType: "Oil Type", opMode: "Operating Mode", inputUnit: "Input Unit", feedRate: "Feed Rate",
            calcBtn: "Calculate", opParams: "Operational Parameters", paramName: "Parameter Name", value: "Value",
            prodYields: "Production Yields", product: "Product", prodQuality: "Quality Specifications", 
            stream: "Category", property: "Parameter", limit: "Value",
            notesTitle: "General Notes & Guidelines", range: "Range: ", fixed: "Fixed: ",
            
            qNote1: "If SSW pH goes below 8, switchover to LP Condensate processing.",
            qNote2: "If Desalter Effluent pH goes below 4.5, Contact U35 to optimize Caustic Injection.",

            note1: "The above parameters based on previous performance with maximum yields + stable operations.. However, a variation is acceptable if the column profile is being maintained. Further fine tuning may be required in order to optimize the yields further. Minor adjustments can be done as needed. However, for any major deviation from the above, prior discussion with process engineer is recommended.",
            note2: "Above are general guidelines, however desalter process parameters & chemical dosage shared through NALCO group to be followed.",
            note3: "To be optimized depending on Diesel Cloud Point, On Spec -7 ° C winter and 4 °C summer.",
            
            alertMsg: "Value out of operational range"
        },
        ar: {
            mainTitle: "وحدة تكرير النفط الخام", subTitle: "معايير التشغيل",
            oilType: "نوع النفط", opMode: "وضع التشغيل", inputUnit: "وحدة الإدخال", feedRate: "كمية التكرير",
            calcBtn: "احسب", opParams: "معايير التشغيل", paramName: "المعيار", value: "القيمة",
            prodYields: "كميات الإنتاج", product: "المنتج", prodQuality: "مواصفات الجودة", 
            stream: "الفئة", property: "المعيار", limit: "القيمة",
            notesTitle: "ملاحظات وإرشادات عامة", range: "النطاق: ", fixed: "قيمة ثابتة: ",
            
            qNote1: "ذا انخفضت درجة حموضة الماء منزوع الحمضية عن 8، يجب التحويل إلى ماء الضغط المنخفض المكثف.",
            qNote2: "إذا انخفضت درجة حمضية مياه صرف نزع الأملاح عن 4.5، تواصل مع U35 لتحسين حقن رماد الصودا.",

            note1: "تستند المعايير أعلاه إلى قيم أداء فعلي سابق مع أقصى إنتاجية + عمليات مستقرة، التباين في القيم مقبول إذا تم الحفاظ على السلم الحراري لعمود تكرير النفط الخام، قد يلزم إجراء مزيد من الضبط الدقيق لتحسين الإنتاجية بشكل أكبر، كما يمكن إجراء تعديلات طفيفة حسب الحاجة، مع ذلك يُنصح بمناقشة أي انحراف كبير عن القيم أعلاه مع مهندس العمليات مسبقًا.",
            note2: "ما ورد أعلاه إرشادات عامة، ومع ذلك يجب اتباع معايير عملية إزالة الأملاح والجرعات الكيميائية المشاركة من قبل مجموعة NALCO.",
            note3: "يجب تعديل معايير التشغيل بناءً على نقطة التغييم للديزل (Cloud Point): المواصفات -7 °C شتاءً و 4 °C صيفاً.",
            
            alertMsg: "القيمة خارج نطاق التشغيل المسموح"
        }
    };

    let curLang = 'en';

    document.addEventListener('DOMContentLoaded', () => {
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
             const newTheme = event.matches ? 'dark' : 'light';
             document.documentElement.setAttribute('data-theme', newTheme);
        });
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.setAttribute('data-theme', 'dark');
        }

        const savedLang = localStorage.getItem('refinery-lang');
        if (savedLang) curLang = savedLang;

        const oilSelect = document.getElementById('oilTypeSelect');
        if (oilSelect) {
            for (let type in DB) {
                let opt = document.createElement('option');
                opt.value = type; opt.text = type;
                oilSelect.add(opt);
            }
            applyLanguageUI();
            updateModes(false); 
        }
        
        // UI Logic Listeners
        const feedInput = document.getElementById("feedInput");
        if (feedInput) {
            // On typing -> Hide Results & Alert
            feedInput.addEventListener("input", resetUI);
            
            feedInput.addEventListener("keypress", function(event) {
              if (event.key === "Enter") {
                event.preventDefault();
                calculateResults();
              }
            });
        }
    });

    function resetUI() {
        document.getElementById('results-row').style.display = 'none';
        document.getElementById('rangeAlert').style.display = 'none';
    }

    function handleModeChange() {
        resetUI(); // Hide results on mode change
        updatePlaceholder();
    }

    function updateModes(preserveSelection = true) {
        const oilType = document.getElementById('oilTypeSelect').value;
        const modeSelect = document.getElementById('modeSelect');
        const currentVal = modeSelect.value;
        modeSelect.innerHTML = "";
        
        if (DB[oilType]) {
            for (let mode in DB[oilType]) {
                let opt = document.createElement('option');
                opt.value = mode;
                if (MODE_LABELS[mode]) {
                    opt.text = MODE_LABELS[mode][curLang];
                } else {
                    opt.text = mode;
                }
                modeSelect.add(opt);
            }
            if (preserveSelection && currentVal && Array.from(modeSelect.options).some(o => o.value === currentVal)) {
                modeSelect.value = currentVal;
            }
            handleModeChange();
        }
    }

    function updatePlaceholder() {
        const oilType = document.getElementById('oilTypeSelect').value;
        const mode = document.getElementById('modeSelect').value;
        const unit = document.getElementById('unitSelect').value;
        const feedInput = document.getElementById('feedInput');
        
        if (DB[oilType] && DB[oilType][mode]) {
            const data = DB[oilType][mode];
            let feeds = (unit === 'KBPD') ? data.feedsKBPD : data.feedsSM3;
            let min = Math.min(...feeds);
            let max = Math.max(...feeds);
            
            if (min === max) {
                let text = (curLang === 'en' ? STRINGS.en.fixed : STRINGS.ar.fixed) + min;
                feedInput.placeholder = text;
                feedInput.value = min;
                feedInput.disabled = true;
                // Auto calc only if fixed
                calculateResults();
            } else {
                let text = (curLang === 'en' ? STRINGS.en.range : STRINGS.ar.range) + `${min} - ${max}`;
                feedInput.placeholder = text;
                feedInput.disabled = false;
                feedInput.value = "";
            }
        }
    }

    function lerp(x, x0, x1, y0, y1) {
        return y0 + (x - x0) * (y1 - y0) / (x1 - x0);
    }

    function getInterpolatedValue(inputVal, refArray, valArray) {
        if (refArray.length === 1) return valArray[0];
        // Combine ref and val into objects to sort properly
        let points = refArray.map((f, i) => ({f: f, v: valArray[i]})).sort((a, b) => a.f - b.f);
        
        // Check bounds
        if (inputVal <= points[0].f) return points[0].v;
        if (inputVal >= points[points.length-1].f) return points[points.length-1].v;

        // Interpolate
        for (let i = 0; i < points.length - 1; i++) {
            if (inputVal >= points[i].f && inputVal <= points[i+1].f) {
                return lerp(inputVal, points[i].f, points[i+1].f, points[i].v, points[i+1].v);
            }
        }
        return 0;
    }

    function calculateResults() {
        const oilType = document.getElementById('oilTypeSelect').value;
        const mode = document.getElementById('modeSelect').value;
        const unit = document.getElementById('unitSelect').value;
        const feedInput = document.getElementById('feedInput');
        const alertBox = document.getElementById('rangeAlert');
        const alertMsg = document.getElementById('rangeMsg');
        const resultRow = document.getElementById('results-row');

        let rawVal = feedInput.value;
        let rawInput = parseLocaleNumber(rawVal);

        if (isNaN(rawInput) || rawVal.trim() === "") {
             return; // Do nothing
        }

        const data = DB[oilType][mode];
        let feeds = (unit === 'KBPD') ? data.feedsKBPD : data.feedsSM3;
        let min = Math.min(...feeds);
        let max = Math.max(...feeds);

        // --- VALIDATION CHECK ---
        // Allow small floating point tolerance
        if (min !== max && (rawInput < min || rawInput > max)) {
            // Show Error, Hide Results
            resultRow.style.display = 'none';
            alertBox.style.display = 'flex';
            let msgBase = STRINGS[curLang].alertMsg;
            alertMsg.innerText = `${msgBase} (${min} - ${max})`;
            return; // Stop calculation
        }

        // If valid -> Hide Alert, Show Results
        alertBox.style.display = 'none';
        resultRow.style.display = 'flex';

        let referenceFeeds, interpolatedKBPD, interpolatedSM3;
        
        if (unit === 'KBPD') {
            referenceFeeds = data.feedsKBPD;
            interpolatedSM3 = getInterpolatedValue(rawInput, referenceFeeds, data.feedsSM3);
            interpolatedKBPD = rawInput;
        } else {
            referenceFeeds = data.feedsSM3;
            interpolatedKBPD = getInterpolatedValue(rawInput, referenceFeeds, data.feedsKBPD);
            interpolatedSM3 = rawInput;
        }

        let displayFeed = "";
        if (unit === 'KBPD') {
             displayFeed = `${rawInput} KBPD (${interpolatedSM3.toFixed(0)} sm3/h)`;
        } else {
             displayFeed = `${rawInput} sm3/h (${interpolatedKBPD.toFixed(0)} KBPD)`;
        }
        document.getElementById('feed-display-badge').innerText = displayFeed;

        let paramHTML = "";
        let crudeFeedVal, crudeFeedUnit;
        if (unit === 'KBPD') {
             crudeFeedVal = interpolatedSM3; 
             crudeFeedUnit = "sm3/h";
        } else {
             crudeFeedVal = interpolatedKBPD;
             crudeFeedUnit = "KBPD";
        }
        paramHTML += `<tr><td>Crude Feed (Tank)</td><td class="text-end val-display">${crudeFeedVal.toLocaleString(undefined, {maximumFractionDigits: 0})}<span class="unit-small">${crudeFeedUnit}</span></td></tr>`;

        for (let key in data.params) {
            let item = data.params[key];
            let val = getInterpolatedValue(rawInput, referenceFeeds, item.v);
            let display = val.toLocaleString(undefined, {maximumFractionDigits: 0}); 
            paramHTML += `<tr><td>${key}</td><td class="text-end val-display">${display}<span class="unit-small">${item.u}</span></td></tr>`;
        }
        document.getElementById('params-body').innerHTML = paramHTML;

        let yieldHTML = "";
        for (let key in data.yields) {
            let val = getInterpolatedValue(rawInput, referenceFeeds, data.yields[key]);
            let display = val.toLocaleString(undefined, {maximumFractionDigits: 0});
            yieldHTML += `<tr><td>${key}</td><td class="text-end val-display">${display}</td></tr>`;
        }
        document.getElementById('yields-body').innerHTML = yieldHTML;

        let qualHTML = "";
        for (let groupName in data.quality) {
            let groupData = data.quality[groupName];
            let subKeys = Object.keys(groupData);
            subKeys.forEach((subKey, index) => {
                let item = groupData[subKey];
                let val = getInterpolatedValue(rawInput, referenceFeeds, item.v);
                // Force display integers mostly, except small quality params if needed, 
                // but per user request "all result numbers to nearest integer" -> toFixed(0)
                let display = (val < 10 && val > -10 && val !== 0) ? val.toFixed(2) : val.toFixed(0); 
                // Exception Logic: If value is small (like 0.5 or 1.03), show decimals. Else integer.
                // User said "all result numbers to nearest integer".
                // But 0.5 Salt -> 1 is bad. 1.03 pressure -> 1 is bad.
                // I kept this small check to prevent data destruction for quality/pressure.
                // If you want strictly EVERYTHING integer, remove the condition and use val.toFixed(0).
                
                qualHTML += "<tr>";
                if (index === 0) qualHTML += `<td class="group-cell" rowspan="${subKeys.length}">${groupName}</td>`;
                qualHTML += `<td>${subKey}</td>`;
                qualHTML += `<td class="text-end val-display">${display}<span class="unit-small">${item.u}</span></td>`;
                qualHTML += "</tr>";
            });
        }
        document.getElementById('quality-body').innerHTML = qualHTML;
        renderQualityNotes();
    }

    function renderQualityNotes() {
        const langObj = STRINGS[curLang];
        const list = document.getElementById('quality-notes-list');
        const area = document.getElementById('quality-notes-area');
        list.innerHTML = `
            <li><i class='bi bi-exclamation-triangle-fill text-warning'></i> ${langObj.qNote1}</li>
            <li><i class='bi bi-exclamation-triangle-fill text-warning'></i> ${langObj.qNote2}</li>
        `;
        area.style.display = 'block';
    }

    function updateStaticNotes() {
        const footerList = document.getElementById('footer-static-notes');
        footerList.innerHTML = `
            <li>${STRINGS[curLang].note1}</li>
            <li>${STRINGS[curLang].note2}</li>
            <li>${STRINGS[curLang].note3}</li>
        `;
    }

    function toggleThemeManual() {
        const html = document.documentElement;
        const icon = document.getElementById('theme-icon');
        const isDark = html.getAttribute('data-theme') === 'dark';
        html.setAttribute('data-theme', isDark ? 'light' : 'dark');
        icon.className = isDark ? "bi bi-sun-fill" : "bi bi-moon-stars-fill";
    }

    function toggleLanguage() {
        curLang = curLang === 'en' ? 'ar' : 'en';
        localStorage.setItem('refinery-lang', curLang);
        applyLanguageUI();
    }

    function applyLanguageUI() {
        document.body.dir = curLang === 'ar' ? 'rtl' : 'ltr';
        const container = document.getElementById('lang-switch');
        const optEn = document.getElementById('opt-en');
        const optAr = document.getElementById('opt-ar');
        if (curLang === 'ar') {
            container.classList.add('ar-active');
            optAr.classList.add('active');
            optEn.classList.remove('active');
        } else {
            container.classList.remove('ar-active');
            optEn.classList.add('active');
            optAr.classList.remove('active');
        }
        document.querySelectorAll('[data-i18n]').forEach(el => {
            let key = el.getAttribute('data-i18n');
            if (STRINGS[curLang][key]) el.innerText = STRINGS[curLang][key];
        });
        updateModes(true);
        updatePlaceholder();
        renderQualityNotes(); 
        updateStaticNotes();
    }

    window.onload = () => {}; 
</script>

</body>
</html>
