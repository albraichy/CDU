<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDU Parameters Dashboard</title>
    <style>
        :root {
            --bg-dark: #121418;
            --card-bg: #1e2229;
            --accent: #4a90e2;
            --text-main: #ffffff;
            --text-secondary: #8b9bb4;
            --success: #4caf50;
            --border: #2f3640;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            padding: 16px;
            line-height: 1.5;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        /* Input Section */
        .input-group {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .input-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        select, input {
            background-color: #2a2f38;
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
            outline: none;
        }

        select:focus, input:focus {
            border-color: var(--accent);
        }

        button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
        }

        button:active {
            opacity: 0.9;
        }

        /* Status Bar */
        .status-bar {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-title {
            color: #a9f3ae; /* Light green for title */
            font-weight: 600;
            font-size: 0.95rem;
        }

        .current-value-display {
            background-color: #9acd32; /* Yellow-green background */
            color: #000; /* Black text for contrast */
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.9rem;
            display: inline-block;
            margin-bottom: 16px;
            width: 100%;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Table Section */
        .table-container {
            background-color: var(--card-bg);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            padding: 16px;
            background-color: #252a33;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .table-row {
            display: flex;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--border);
            align-items: center;
        }

        .table-row:last-child {
            border-bottom: none;
        }

        .param-name {
            font-size: 0.95rem;
            color: #e0e0e0;
        }

        .param-value {
            font-family: 'Roboto Mono', monospace;
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-main);
        }

        .param-unit {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-left: 4px;
            font-weight: 400;
        }

        .error-msg {
            color: #ff5252;
            font-size: 0.9rem;
            margin-top: 8px;
            display: none;
        }

    </style>
</head>
<body>

<div class="container">
    <div class="input-group">
        <label class="label">Input Unit</label>
        <div style="margin-bottom: 16px;">
            <select id="unitSelector">
                <option value="KBPD">KBPD</option>
                <option value="sm3/h">sm3/h</option>
            </select>
        </div>

        <label class="label">Feed Rate</label>
        <div class="input-row">
            <input type="number" id="feedInput" placeholder="Enter value" step="0.1">
            <button onclick="calculate()">Calculate</button>
        </div>
        <div id="errorMsg" class="error-msg">Value out of range</div>
    </div>

    <div class="status-bar">
        <span style="font-size: 1.2rem;">dashboard</span> 
        <span class="status-title">Operational Parameters</span>
    </div>

    <div class="current-value-display" id="headerDisplay">
        <span id="displayMain">0 KBPD</span>
        <span id="displaySub" style="font-weight: 400; font-size: 0.85rem;">(0 sm3/h)</span>
    </div>

    <div class="table-container" id="resultsTable">
        <div class="table-header">
            <span>Parameter Name</span>
            <span>Value</span>
        </div>
        </div>
</div>

<script>
    // --- Configuration ---
    // 1 KBPD = 6.62447 sm3/h (approx conversion factor used for display logic, 
    // but specific interpolation follows the table below)
    
    // DATA TABLE (CONSTANTS from Excel)
    // Defines the exact points. 
    // Col 0: Feed (KBPD), Col 1: Feed (sm3/h)
    // Subsequent columns match the 'parameters' list order.
    const dataPoints = [
        // [KBPD, sm3/h, Crude, Slops, WildNap, HeaterFeed, WashV02, WashE01, V0001, V0002, E10, HeaterOut, ColTop, TopPress, PumpAround, PumpDraw]
        [100,  662.4,  662,  10.0, 5.0,  650,  25.0, 8.0,  145.0, 144.0, 195.0, 365, 110, 1.0, 800,  120],
        [150,  993.7,  994,  15.0, 7.5,  980,  37.5, 12.5, 147.0, 146.0, 197.0, 368, 111, 1.0, 1200, 123],
        [200,  1324.9, 1325, 35.0, 9.8,  1215, 50.0, 16.5, 149.0, 148.0, 199.0, 370, 112, 1.0, 1600, 126],
        [205,  1358.0, 1342, 36.1, 10.0, 1230, 50.2, 16.7, 149.3, 148.4, 199.9, 371, 112, 1.0, 1620, 126.9],
        [250,  1656.1, 1656, 40.0, 12.0, 1500, 62.0, 20.0, 152.0, 151.0, 205.0, 375, 115, 1.1, 1800, 130]
    ];

    // Parameter Definitions (Corrected Names & Units)
    const parameters = [
        { name: "Crude Feed (Tank)", unit: "sm3/h" },
        { name: "Slops", unit: "sm3/h" },
        { name: "Wild Naphtha", unit: "sm3/h" },
        { name: "Heater Feed Rate", unit: "sm3/h" },
        { name: "Washwater to Desalter V02 (75% of total)", unit: "sm3/h" }, // Fixed unit, removed (2)
        { name: "Washwater to E01", unit: "sm3/h" }, // Fixed unit
        { name: "V-0001 inlet temperature", unit: "°C" }, // Removed (2)
        { name: "V-0002 inlet temperature", unit: "°C" }, // Removed (2)
        { name: "E-10 Exchanger Outlet Temp to Preflash Drum", unit: "°C" }, // Removed (3)
        { name: "Heater Outlet Temperature", unit: "°C" },
        { name: "Column Top Temperature", unit: "°C" },
        { name: "Top Column Pressure", unit: "barg" },
        { name: "Top Pump Around Flow", unit: "sm3/h" },
        { name: "Top Pump Around Draw Temperature", unit: "°C" }
    ];

    // Initialize Table
    function initTable() {
        const container = document.getElementById('resultsTable');
        container.innerHTML = `
            <div class="table-header">
                <span>Parameter Name</span>
                <span>Value</span>
            </div>
        `;
        
        parameters.forEach((param, index) => {
            const row = document.createElement('div');
            row.className = 'table-row';
            row.innerHTML = `
                <span class="param-name">${param.name}</span>
                <div>
                    <span class="param-value" id="val-${index}">-</span>
                    <span class="param-unit">${param.unit}</span>
                </div>
            `;
            container.appendChild(row);
        });
    }

    // Linear Interpolation Function
    function interpolate(x, x0, x1, y0, y1) {
        if (x1 === x0) return y0;
        return y0 + (x - x0) * (y1 - y0) / (x1 - x0);
    }

    // Format Number with commas and decimal places
    function formatNumber(num, decimals = 1) {
        return num.toLocaleString('en-US', { 
            minimumFractionDigits: decimals, 
            maximumFractionDigits: decimals 
        });
    }

    function calculate() {
        const unit = document.getElementById('unitSelector').value;
        const rawInput = parseFloat(document.getElementById('feedInput').value);
        const errorMsg = document.getElementById('errorMsg');

        if (isNaN(rawInput)) {
            return;
        }

        // 1. Unify Input to a standard "Search Key" (using KBPD column for lookup)
        // Col 0 is KBPD, Col 1 is sm3/h
        let searchValKBPD = 0;
        
        // Simple conversion logic ONLY to find position in table
        // Real values will be interpolated from table columns
        if (unit === 'KBPD') {
            searchValKBPD = rawInput;
        } else {
            // If input is sm3/h, we need to find where it fits in Col 1, then map to Col 0
            // For simplicity in lookup, we'll iterate the table rows directly
        }

        // 2. Find Upper and Lower bounds in the table
        let lowerRow = null;
        let upperRow = null;
        let inputColIndex = (unit === 'KBPD') ? 0 : 1; // Which column in dataPoints matches the user input
        
        // Sort just in case, though array is sorted
        const sortedData = dataPoints.sort((a,b) => a[0] - b[0]);

        // Boundary Checks
        const minVal = sortedData[0][inputColIndex];
        const maxVal = sortedData[sortedData.length - 1][inputColIndex];

        if (rawInput < minVal || rawInput > maxVal) {
            errorMsg.style.display = 'block';
            errorMsg.innerText = `Input out of range (${minVal} - ${maxVal})`;
            return;
        } else {
            errorMsg.style.display = 'none';
        }

        // Locate Bracket
        for (let i = 0; i < sortedData.length - 1; i++) {
            const current = sortedData[i][inputColIndex];
            const next = sortedData[i+1][inputColIndex];
            
            if (rawInput >= current && rawInput <= next) {
                lowerRow = sortedData[i];
                upperRow = sortedData[i+1];
                break;
            }
        }

        if (!lowerRow || !upperRow) return; // Should not happen due to boundary check

        // 3. Update Header Display (Show both units accurately)
        let displayKBPD, displaySM3;
        
        // Calculate the "Other" unit for the header using interpolation
        // The Input Unit Value is exactly what the user typed (rawInput)
        // The Other Unit Value is interpolated from the table
        
        if (unit === 'KBPD') {
            displayKBPD = rawInput;
            // Interpolate sm3/h (Col 1) based on KBPD (Col 0)
            displaySM3 = interpolate(rawInput, lowerRow[0], upperRow[0], lowerRow[1], upperRow[1]);
        } else {
            displaySM3 = rawInput;
            // Interpolate KBPD (Col 0) based on sm3/h (Col 1)
            displayKBPD = interpolate(rawInput, lowerRow[1], upperRow[1], lowerRow[0], upperRow[0]);
        }

        // Update Green Box Header
        document.getElementById('displayMain').innerText = `${formatNumber(unit === 'KBPD' ? displayKBPD : displaySM3, 1)} ${unit}`;
        document.getElementById('displaySub').innerText = `(${formatNumber(unit === 'KBPD' ? displaySM3 : displayKBPD, 1)} ${unit === 'KBPD' ? 'sm3/h' : 'KBPD'})`;


        // 4. Calculate and Update All Parameters
        // Parameters start from Col 2 in dataPoints
        // We perform linear interpolation for every column against the Input Column
        
        parameters.forEach((param, index) => {
            const colIndex = index + 2; // Shift because 0,1 are Feed Rates
            
            const y0 = lowerRow[colIndex];
            const y1 = upperRow[colIndex];
            const x0 = lowerRow[inputColIndex];
            const x1 = upperRow[inputColIndex];
            
            const result = interpolate(rawInput, x0, x1, y0, y1);
            
            // Update DOM
            document.getElementById(`val-${index}`).innerText = formatNumber(result, 1);
        });
    }

    // Init
    initTable();
</script>

</body>
</html>
