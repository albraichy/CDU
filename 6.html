<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDU Parameters Dashboard</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent: #007bff;
            --border: #404040;
            --success: #28a745;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        h1 { margin: 0; font-size: 1.5rem; color: var(--accent); }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label { font-size: 0.9rem; color: var(--text-muted); }

        select, input {
            background-color: #3d3d3d;
            border: 1px solid var(--border);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 1rem;
        }

        input[type="number"] { width: 120px; }

        button {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        button:hover { background-color: #0056b3; }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border);
        }

        .card-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            color: var(--success);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #404040;
        }

        td.value {
            text-align: right;
            font-family: 'Consolas', monospace;
            color: #4fc3f7;
            font-weight: bold;
        }
        
        td.unit {
            text-align: center;
            color: var(--text-muted);
            width: 50px;
        }

        .highlight-row { background-color: rgba(0, 123, 255, 0.1); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>CDU Parameters Dashboard</h1>
        <div class="controls">
            <div class="control-group">
                <label>Select Case / Mode</label>
                <select id="caseSelect" onchange="updateDashboard()">
                    <option value="KEC_HD">KEC Max. with Heavy Diesel</option>
                    <option value="KEC_NoHD">KEC Max. without Heavy Diesel</option>
                    <option value="KEC_Naphtha">KEC Max. Naphtha Mode</option>
                    <option value="KSRC">KSRC Base Case</option>
                    <option value="KMHC">KMHC Base Case</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Input Unit</label>
                <select id="unitSelect" onchange="updateDashboard()">
                    <option value="KBPD">KBPD</option>
                    <option value="sm3hr">sm3/hr</option>
                </select>
            </div>

            <div class="control-group">
                <label>Feed Rate Input</label>
                <input type="number" id="feedInput" value="200000" step="100" onchange="updateDashboard()">
            </div>
            
            <button onclick="updateDashboard()">Calculate</button>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <div class="card-title">Operating Parameters</div>
            <table id="mainParamsTable">
                </table>
        </div>

        <div class="card">
            <div class="card-title">Temperatures & Pressures</div>
            <table id="tempPressTable">
                </table>
        </div>

        <div class="card">
            <div class="card-title">Product Yields</div>
            <table id="yieldsTable">
                </table>
        </div>
        
         <div class="card">
            <div class="card-title">Product Quality</div>
            <table id="qualityTable">
                </table>
        </div>
    </div>
</div>

<script>
/**
 * DATA STORE - Extracted EXACTLY from uploaded CSVs.
 * Each array corresponds to the columns in the CSV.
 * Order matches the Feed array.
 */
const DB = {
    "KEC_HD": {
        // Headers: 205k, 200k, 175k, 155k, 130k, 105k
        "Feed_KBPD": [205000, 200000, 175000, 155000, 130000, 105000],
        "Feed_SM3":  [1341.951991, 1321.033948, 1159.377848, 1031.274637, 851.621826, 696.440801],
        "params": {
            "Slops (sm3/hr)": [36.106372, 33.015007, 29.540891, 41.127942, 3.253879, 0],
            "Wild Naphtha (sm3/hr)": [10.001416, 9.099249, 26.766919, 10.242188, 6.601427, 9.962496],
            "Heater Feed Rate (sm3/hr)": [1230.000083, 1220.001341, 1055.923089, 969.972893, 804.682980, 659.995091],
            "Washwater V02 (%)": [50.227652, 53.000019, 45.468433, 41.074638, 33.999966, 26.999822],
            "Washwater E01 (%)": [16.743041, 17.999916, 14.992113, 13.537255, 11.999146, 9.000259],
            "V-0001 Inlet Temp (°C)": [149.302138, 148.769760, 150.036856, 147.989337, 148.781775, 147.323743],
            "Heater Outlet Temp (°C)": [370.996430, 370.827385, 370.929720, 370.961264, 370.329332, 370.990526],
            "Column Top Temp (°C)": [111.997859, 111.999515, 111.998582, 111.003529, 111.007182, 111.002178],
            "Top Pump Around Flow (sm3/hr)": [1620.595920, 1549.988153, 1385.006041, 1359.997501, 1159.984360, 1169.999338],
            "Middle Pump Around Flow (sm3/hr)": [1185.990901, 1123.998158, 1015.005063, 890.001767, 765.592522, 685.003191],
            "Bottom Pump Around Flow (sm3/hr)": [899.998943, 1001.995621, 775.002137, 780.001867, 700.005222, 540.996098],
            "Column Bottom Temp (°C)": [347.594398, 348.524915, 345.416373, 347.388624, 344.039343, 341.862458],
            "Kerosene Draw Temp (°C)": [178.345232, 176.073399, 178.743471, 176.292065, 176.823983, 178.843127],
            "Light Diesel Draw Temp (°C)": [263.995408, 261.892199, 265.781791, 261.127767, 259.209522, 259.498573],
            "Heavy Diesel Draw Temp (°C)": [318.315950, 319.896708, 317.311468, 315.846909, 309.935974, 309.644428],
            "Overflash Flow (sm3/hr)": [112.534613, 84.297085, 108.441318, 83.480187, 75.153248, 72.742261],
            "Stripping Steam Crude (kg/hr)": [22500.00681, 21997.97298, 20500.00752, 17499.93900, 15374.18660, 15500.07968],
            "Stripping Steam Lt Dsl (kg/hr)": [1199.998023, 2150.015468, 1092.001106, 1450.004393, 1209.127726, 999.992125],
            "Stripping Steam Hy Dsl (kg/hr)": [350.000781, 449.999825, 300.000070, 299.998833, 299.997682, 300.005886],
            "LPG Yield (sm3/hr)": [15.947474, 17.298028, 13.077076, 14.602799, 15.209619, 12.659119],
            "Naphtha Yield (sm3/hr)": [265.677473, 258.468001, 214.393525, 193.099725, 142.734633, 107.830417],
            "Kerosene Yield (sm3/hr)": [240.600844, 240.853982, 204.836227, 182.649030, 128.097892, 111.528736],
            "Lt Diesel Yield (sm3/hr)": [199.046858, 200.494803, 185.356238, 161.409235, 134.923256, 104.804903],
            "Hy Diesel Yield (sm3/hr)": [55.000065, 67.000061, 19.999953, 29.999795, 19.999647, 25.000539],
            "AR Yield (sm3/hr)": [618.384680, 601.209910, 541.306900, 500.192468, 443.915024, 358.720975],
            "Desalted Crude Salt (HEM)": [0.8, 0.5, 0.68, 0.55, 0.45, 0.6],
            "Desalted Crude BS&W": [1.4, 1, 0.7, 0.6, 0.5, 0.5]
        }
    },
    "KEC_NoHD": {
        // Headers: 200k, 195k, 180k, 160k, 150k, 120k, 105k
        "Feed_KBPD": [200000, 195000, 180000, 160000, 150000, 120000, 105000],
        "Feed_SM3":  [1326.665770, 1300.330711, 1203.853597, 1060.675869, 979.945902, 789.698034, 689.369306],
        "params": {
            "Slops (sm3/hr)": [48.770918, 25.815910, 3.369333, 34.193014, 24.563925, -0.000034, 0],
            "Wild Naphtha (sm3/hr)": [0, 6.994196, 29.999339, 8.176711, 0, 27.788769, 11.949116],
            "Heater Feed Rate (sm3/hr)": [1220.015141, 1200.050845, 1080.752131, 960.000343, 897.706573, 673.760775, 660.007333],
            "Washwater V02 (%)": [49.617067, 51.998990, 44.600203, 45.500153, 37.066188, 31.500001, 27.000130],
            "Washwater E01 (%)": [16.484832, 20.000046, 14.879918, 14.499957, 12.354265, 10.499899, 9.000030],
            "V-0001 Inlet Temp (°C)": [146.665188, 150.847228, 150.296401, 150.579288, 149.567070, 149.586517, 147.525039],
            "Heater Outlet Temp (°C)": [371.014224, 368.614128, 370.984514, 370.989238, 370.969086, 367.967278, 370.999405],
            "Column Top Temp (°C)": [110.999493, 111.064275, 111.994962, 110.001584, 112.006682, 112.372707, 111.004945],
            "Top Pump Around Flow (sm3/hr)": [1669.997348, 1345.207320, 1430.676293, 1390.934046, 1191.471068, 1058.259181, 1169.998537],
            "Middle Pump Around Flow (sm3/hr)": [1179.996850, 1245.006896, 1039.967719, 891.921102, 869.929079, 797.894907, 682.475838],
            "Bottom Pump Around Flow (sm3/hr)": [965.250684, 1044.785903, 790.002041, 769.827005, 665.708445, 619.851047, 540.532563],
            "Column Bottom Temp (°C)": [344.147505, 341.408622, 344.405668, 342.606878, 344.537056, 339.186472, 336.106998],
            "Kerosene Draw Temp (°C)": [175.944510, 176.413905, 174.759358, 174.546043, 179.063797, 173.149789, 179.142053],
            "Light Diesel Draw Temp (°C)": [264.793613, 268.831874, 264.291523, 262.167494, 265.945805, 259.855820, 260.615236],
            "Heavy Diesel Draw Temp (°C)": [24.478103, 43.450284, 53.254840, 48.610318, 32.793678, 44.222756, 22.258982],
            "Overflash Flow (sm3/hr)": [33.402631, 0.051297, 151.870660, 126.486954, 85.359962, 67.733986, 86.904739],
            "Stripping Steam Crude (kg/hr)": [23893.36317, 23944.07031, 19996.91552, 20522.97428, 17341.41886, 14314.21937, 15248.32316],
            "Stripping Steam Lt Dsl (kg/hr)": [1299.999724, 2300.010083, 1099.999757, 1199.996982, 941.246794, 2035.484927, 1000.003069],
            "Stripping Steam Hy Dsl (kg/hr)": [26.980369, 104.927043, -12.5, -12.5, 82.855854, 127.904122, 35.043547],
            "LPG Yield (sm3/hr)": [17.887519, 2.022554, 12.637458, 11.607528, 12.487324, 0.805911, 12.540890],
            "Naphtha Yield (sm3/hr)": [267.374981, 224.874870, 234.723972, 186.989147, 183.037636, 137.916538, 111.686369],
            "Kerosene Yield (sm3/hr)": [242.992334, 228.087809, 204.410033, 166.528148, 168.541565, 103.649302, 110.894654],
            "Lt Diesel Yield (sm3/hr)": [207.755144, 198.113320, 195.029307, 174.241976, 157.885787, 133.730979, 110.301087],
            "Hy Diesel Yield (sm3/hr)": [0, 0, 0, 0, 0, 0, 0],
            "AR Yield (sm3/hr)": [651.603972, 679.761030, 577.646316, 541.286012, 479.130860, 390.099116, 376.705517],
            "Desalted Crude Salt (HEM)": [0.65, 0.6, 0.6, 0.7, 1, 0.6, 0.6],
            "Desalted Crude BS&W": [1.3, 0.6, 0.8, 0.7, 0.55, 0.5, 0.5]
        }
    },
    "KEC_Naphtha": {
        "Feed_KBPD": [205000],
        "Feed_SM3": [1367.703151],
        "params": {
            "Slops (sm3/hr)": [10.614249],
            "Wild Naphtha (sm3/hr)": [20.393633],
            "Heater Feed Rate (sm3/hr)": [1200.022677],
            "Washwater V02 (%)": [53.500179],
            "Washwater E01 (%)": [17.799735],
            "V-0001 Inlet Temp (°C)": [149.995921],
            "Heater Outlet Temp (°C)": [371.020905],
            "Column Top Temp (°C)": [115.074789],
            "Top Pump Around Flow (sm3/hr)": [1621.018401],
            "Middle Pump Around Flow (sm3/hr)": [1260.993308],
            "Bottom Pump Around Flow (sm3/hr)": [900.985698],
            "Column Bottom Temp (°C)": [343.486954],
            "Kerosene Draw Temp (°C)": [177.223190],
            "Light Diesel Draw Temp (°C)": [269.625598],
            "Heavy Diesel Draw Temp (°C)": [65.624719],
            "Overflash Flow (sm3/hr)": [99.171286],
            "Stripping Steam Crude (kg/hr)": [24500.05986],
            "Stripping Steam Lt Dsl (kg/hr)": [930.011236],
            "Stripping Steam Hy Dsl (kg/hr)": [0],
            "LPG Yield (sm3/hr)": [10.288969],
            "Naphtha Yield (sm3/hr)": [248.520862],
            "Kerosene Yield (sm3/hr)": [226.914996],
            "Lt Diesel Yield (sm3/hr)": [222.002610],
            "Hy Diesel Yield (sm3/hr)": [0],
            "AR Yield (sm3/hr)": [653.560812],
            "Desalted Crude Salt (HEM)": [0.7],
            "Desalted Crude BS&W": [1]
        }
    },
    "KSRC": {
        "Feed_KBPD": [120000],
        "Feed_SM3": [809.863103],
        "params": {
            "Slops (sm3/hr)": [7.521918],
            "Wild Naphtha (sm3/hr)": [3.579922],
            "Heater Feed Rate (sm3/hr)": [949.973276],
            "Washwater V02 (%)": [72.000312],
            "Washwater E01 (%)": [24.000058],
            "V-0001 Inlet Temp (°C)": [149.692527],
            "Heater Outlet Temp (°C)": [369.997150],
            "Column Top Temp (°C)": [112.989089],
            "Top Pump Around Flow (sm3/hr)": [1270.001067],
            "Middle Pump Around Flow (sm3/hr)": [861.819298],
            "Bottom Pump Around Flow (sm3/hr)": [532.311104],
            "Column Bottom Temp (°C)": [348.056451],
            "Kerosene Draw Temp (°C)": [188.511539],
            "Light Diesel Draw Temp (°C)": [261.719373],
            "Heavy Diesel Draw Temp (°C)": [25.061364],
            "Overflash Flow (sm3/hr)": [61.646291],
            "Stripping Steam Crude (kg/hr)": [9649.90263],
            "Stripping Steam Lt Dsl (kg/hr)": [2500.002529],
            "Stripping Steam Hy Dsl (kg/hr)": [109.079161],
            "LPG Yield (sm3/hr)": [-0.037783],
            "Naphtha Yield (sm3/hr)": [128.037217],
            "Kerosene Yield (sm3/hr)": [46.745708],
            "Lt Diesel Yield (sm3/hr)": [142.979582],
            "Hy Diesel Yield (sm3/hr)": [0],
            "AR Yield (sm3/hr)": [532.775482],
            "Desalted Crude Salt (HEM)": [0.4],
            "Desalted Crude BS&W": [0.7]
        }
    },
    "KMHC": {
        "Feed_KBPD": [200000, 120000],
        "Feed_SM3": [1312.020979, 810.733411],
        "params": {
            "Slops (sm3/hr)": [24.850349, 0],
            "Wild Naphtha (sm3/hr)": [1.725803, 3.137898],
            "Heater Feed Rate (sm3/hr)": [1199.929299, 734.770115],
            "Washwater V02 (%)": [51.999320, 51.178091],
            "Washwater E01 (%)": [19.999990, 17.059160],
            "V-0001 Inlet Temp (°C)": [150.884693, 144.685066],
            "Heater Outlet Temp (°C)": [369.097458, 370.332906],
            "Column Top Temp (°C)": [111.672249, 112.423154],
            "Top Pump Around Flow (sm3/hr)": [1339.418869, 1269.554105],
            "Middle Pump Around Flow (sm3/hr)": [1242.739371, 623.277421],
            "Bottom Pump Around Flow (sm3/hr)": [1037.706358, 547.622083],
            "Column Bottom Temp (°C)": [341.987645, 347.716296],
            "Kerosene Draw Temp (°C)": [177.004133, 178.676232],
            "Light Diesel Draw Temp (°C)": [269.210917, 259.177570],
            "Heavy Diesel Draw Temp (°C)": [42.920285, 22.597720],
            "Overflash Flow (sm3/hr)": [0.159672, 97.306475],
            "Stripping Steam Crude (kg/hr)": [23972.13801, 15123.41389],
            "Stripping Steam Lt Dsl (kg/hr)": [2340.485514, 1775.675436],
            "Stripping Steam Hy Dsl (kg/hr)": [107.976042, 108.444705],
            "LPG Yield (sm3/hr)": [3.111010, 3.561126],
            "Naphtha Yield (sm3/hr)": [222.702894, 130.035674],
            "Kerosene Yield (sm3/hr)": [224.611557, 105.778024],
            "Lt Diesel Yield (sm3/hr)": [197.625965, 128.290127],
            "Hy Diesel Yield (sm3/hr)": [0, 0],
            "AR Yield (sm3/hr)": [680.007124, 424.495410],
            "Desalted Crude Salt (HEM)": [0.6, 1.1],
            "Desalted Crude BS&W": [0.6, 1]
        }
    }
};

/**
 * Main Calculation Function
 */
function updateDashboard() {
    const caseType = document.getElementById('caseSelect').value;
    const unitType = document.getElementById('unitSelect').value;
    let inputFeed = parseFloat(document.getElementById('feedInput').value);

    const data = DB[caseType];
    const feedsKBPD = data.Feed_KBPD;
    const feedsSM3 = data.Feed_SM3;

    let targetFeed = inputFeed;
    let refArray = [];
    let otherArray = [];
    
    // Determine which array to use for search based on unit
    if (unitType === 'KBPD') {
        refArray = feedsKBPD;
        otherArray = feedsSM3;
    } else {
        refArray = feedsSM3;
        otherArray = feedsKBPD;
    }

    // Single point case (KSRC, KEC Naphtha)
    if (refArray.length === 1) {
        renderTables(data, 0, 0, 0, unitType, inputFeed, otherArray[0]);
        return;
    }

    // Find interpolation interval
    // Note: Arrays are descending (High -> Low) usually, but we need to handle generic.
    // Check direction
    const isDescending = refArray[0] > refArray[refArray.length - 1];
    
    let idx = -1;
    
    if (isDescending) {
        // Find i such that refArray[i] >= target >= refArray[i+1]
        for (let i = 0; i < refArray.length - 1; i++) {
            if (targetFeed <= refArray[i] && targetFeed >= refArray[i+1]) {
                idx = i;
                break;
            }
        }
        // Clamping if out of bounds
        if (targetFeed > refArray[0]) idx = 0; // Use max
        if (targetFeed < refArray[refArray.length - 1]) idx = refArray.length - 2; // Use min
        
        // If not found in loop (should be caught by clamping, but safety check)
        if (idx === -1) idx = 0;

    } else {
        // Ascending Logic (just in case future data changes)
        for (let i = 0; i < refArray.length - 1; i++) {
            if (targetFeed >= refArray[i] && targetFeed <= refArray[i+1]) {
                idx = i;
                break;
            }
        }
        if (targetFeed < refArray[0]) idx = 0;
        if (targetFeed > refArray[refArray.length - 1]) idx = refArray.length - 2;
    }

    // Calculate Interpolation Factor (t)
    // Formula: Val = y1 + (x - x1) * (y2 - y1) / (x2 - x1)
    const x1 = refArray[idx];
    const x2 = refArray[idx + 1];
    
    // Avoid division by zero
    let t = 0;
    if (x2 !== x1) {
        t = (targetFeed - x1) / (x2 - x1);
    }

    // Calculate the 'Other Unit' feed value
    const otherFeedVal = otherArray[idx] + t * (otherArray[idx+1] - otherArray[idx]);

    renderTables(data, idx, idx+1, t, unitType, targetFeed, otherFeedVal);
}

function renderTables(data, i1, i2, t, inputUnit, inputVal, convertedVal) {
    const mainTable = document.getElementById('mainParamsTable');
    const tempTable = document.getElementById('tempPressTable');
    const yieldTable = document.getElementById('yieldsTable');
    const qualityTable = document.getElementById('qualityTable');

    mainTable.innerHTML = '';
    tempTable.innerHTML = '';
    yieldTable.innerHTML = '';
    qualityTable.innerHTML = '';

    // Helper to add row
    function addRow(table, label, val, unit) {
        const row = table.insertRow();
        row.insertCell(0).innerText = label;
        const valCell = row.insertCell(1);
        valCell.className = 'value';
        valCell.innerText = val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        const unitCell = row.insertCell(2);
        unitCell.className = 'unit';
        unitCell.innerText = unit;
    }

    // 1. Add Feed Rows explicitly
    let valKBPD = (inputUnit === 'KBPD') ? inputVal : convertedVal;
    let valSM3 = (inputUnit === 'sm3hr') ? inputVal : convertedVal;
    
    addRow(mainTable, "Feed Rate (KBPD)", valKBPD, "KBPD");
    addRow(mainTable, "Crude Feed (Tank)", valSM3, "sm3/hr");

    // 2. Iterate all params and categorize
    for (const [key, values] of Object.entries(data.params)) {
        let calculatedValue = 0;
        if (values.length === 1) {
            calculatedValue = values[0]; // Constant
        } else {
            const v1 = values[i1];
            const v2 = values[i2];
            calculatedValue = v1 + t * (v2 - v1);
        }

        // Clean Unit from Key
        let displayLabel = key.split('(')[0].trim();
        let displayUnit = "";
        if (key.includes('(')) {
            displayUnit = key.split('(')[1].replace(')', '');
        }

        // Categorize
        if (key.includes('Yield')) {
            addRow(yieldTable, displayLabel, calculatedValue, displayUnit);
        } else if (key.includes('Temp') || key.includes('Press')) {
            addRow(tempTable, displayLabel, calculatedValue, displayUnit);
        } else if (key.includes('Salt') || key.includes('BS&W') || key.includes('pH')) {
            addRow(qualityTable, displayLabel, calculatedValue, displayUnit);
        } else {
            addRow(mainTable, displayLabel, calculatedValue, displayUnit);
        }
    }
}

// Initial Run
updateDashboard();

</script>

</body>
</html>
